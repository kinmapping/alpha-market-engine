# 暗号資産自動売買システム - ドメインルール

このドキュメントは、暗号資産自動売買システムの実装時に参照すべきドメインルールと技術要件をまとめたものです。

## 目次

1. [暗号資産取引の基本概念](#暗号資産取引の基本概念)
2. [取引所APIと技術スタック](#取引所apiと技術スタック)
3. [Bot戦略の種類](#bot戦略の種類)
4. [システムアーキテクチャ](#システムアーキテクチャ)
5. [コスト計算と損益モデル](#コスト計算と損益モデル)
6. [実装上のドメインルール](#実装上のドメインルール)

---

## 暗号資産取引の基本概念

### 取引の種類

**1. 板取引（Spot Trading）**

「BTC/JPY」「ETH/USDT」のような通貨ペアで、注文板に注文を出して売買する方式。

**技術要件**:
- 価格データ取得: WebSocket（リアルタイム）
- 発注・約定処理: REST API
- アルゴリズム実装には REST と WebSocket の両方が必要

**2. 証拠金・先物取引（Futures/Perpetual）**

Bybit・Binance などが提供。レバレッジを効かせた高速取引が可能。

**技術要件**:
- 手数料構造と funding rate の理解が重要
- プログラム的には「レイテンシとの戦い」が主な課題

**3. DeFi（分散型金融）**

中央取引所（CEX）ではなく、スマートコントラクト上で行う自動マーケットメイカー（AMM）。Uniswap、Curve、EigenLayer、LRT/LST など。

**技術要件**:
- API ではなく「データの取得方法」と「スマートコントラクトの呼び出し方法」が主な課題

### 技術スタックの基本構成

```
価格データ     → WebSocket
約定処理       → REST API
指値・成行の扱い → ロジック層
ポジション管理 → Redis or PostgreSQL
ログ・トレーシング → OpenTelemetry
分析          → Python + pandas（or DuckDB）
バックテスト   → 自作推奨、初期は pandas で十分
```

### 異常系処理の重要性

CEX 取引 bot で最重要なのは「異常系」の処理。

**必須対応項目**:
- ネットワーク切断
- API 制限（レート制限）
- 注文失敗
- エラー返信
- ずれたタイムスタンプ

これらを適切に処理できると、システムの堅牢性が劇的に向上する。

---

## 取引所APIと技術スタック

### WebSocket（価格データ）

**用途**: リアルタイム価格データの取得

- ticker（現在価格）
- orderbooks（板情報）
- trades（約定履歴）

### REST API（約定処理）

**用途**: 発注・取消・残高取得

- HMAC認証が必要
- レート制限の考慮が必須
- リトライロジックの実装が必要

### 指値・成行の扱い

**指値（Limit Order）**:
- 指定価格で注文を板に置く
- Maker として扱われ、手数料が安い（場合によってはリベート）

**成行（Market Order）**:
- 即座に約定を優先
- Taker として扱われ、手数料が高い
- スリッページのリスクあり

**ロジック層での判断**:
- 戦略に応じて指値/成行を選択
- 板の厚さを考慮した最適な執行方法の選択

### ポジション管理

**推奨ストレージ**:
- Redis: 高速な状態管理に適している
- PostgreSQL: 履歴管理と分析に適している

**管理すべき情報**:
- 現在のポジション（数量・平均取得価額）
- 約定履歴
- 損益状況

### ログ・トレーシング

**推奨ツール**: OpenTelemetry

**記録すべき情報**:
- すべての取引履歴
- エラー・例外
- パフォーマンスメトリクス
- システム状態の変化

---

## Bot戦略の種類

### 1. シグナル追従型

**概要**: テクニカル指標をそのまま売買シグナルに変換

**例**:
- 移動平均（MA）クロス
- RSI の閾値判定
- ボリンジャーバンドの上下タッチ

**特徴**:
- 実装が単純
- トレンド相場では有効
- 横ばい相場では損失が積み上がりやすい

### 2. アービトラージ

**概要**: 取引所間の価格差を利用

**種類**:
- 取引所間アービトラージ
- 三角アービトラージ（USDT → BTC → ETH → USDT のように回して差益を取る）

**技術要件**:
- 速度・手数料・送金時間が支配要因
- API の品質が高いほど成立しやすい

### 3. マーケットメイキング

**概要**: 板に薄く注文を置き、スプレッド（売り買いの差）を取りにいく

**特徴**:
- 価格予測はしない
- レイテンシと約定率が命
- 暗号資産の初期流動性を個人 bot が支えていた歴史がある

### 4. AI/統計的手法

**概要**: 機械学習や統計的手法を組み込んだ予測モデル

**手法例**:
- リッジ回帰
- LSTM（時系列モデル）
- Transformer 系の埋め込み

**重要なポイント**:
- 予測精度そのものより「どの市場状態で機能するか」が重要
- モデル選びは環境選びと言える

### 戦略設計の原則

**相場の動きをどう捉えるか（ルール）と、取引所とのやり取り（実装）の境界をきれいに分けて設計するのが長生きする方法。**

---

## システムアーキテクチャ

### 三層構造

alpha-market-engine は以下の三層構造を採用:

1. **戦略層**: 市場データを分析し、売買シグナルを生成
2. **価格層**: WebSocket で価格データを取得・配信
3. **注文層**: REST API で発注・約定処理を実行

**原則**: どれを交換しても破綻しない作りにする

### 分離の原則

**「壊れないこと」と「見えること」を実現するため、以下を分離する:**

1. **価格取得**: WebSocket を別コンテナで受け、メッセージキュー（Redis Stream や Kafka）に流す
2. **注文送信**: REST で発注に専念するコンテナ
3. **戦略判断**: データだけを読んで判断するコンテナ

この分離により、どこが壊れたかを簡単に切り分けられる。

### ストレージ設計

**履歴管理**: PostgreSQL か DuckDB

**ログ**: OpenTelemetry で可視化

**指標計算**: Python

**戦略**: プラグイン方式にして、差し替えやすくする

### 責務の分離

**取引所以外の責務を bot に背負わせないこと:**

- 値幅計算
- 資金管理
- 注文の Retries
- API のエラー解析

これらはすべて bot の内部ロジックとして独立させると事故が劇的に減る。

---

## コスト計算と損益モデル

### サーバー運用コスト

**最小構成（低頻度〜中頻度の現物/簡易先物）**

- Lightsail 最安付近: **$3.5〜$5/月**（約 500〜800円）
- EC2 t4g.micro 相当: **約 $4〜$10/月**（リージョン差あり）

**結論**: VPS 1 台で十分、月 1,000 円以内に収まる

**中規模構成（複数取引所/複数戦略/バックテストも同居）**

- 2vCPU・2GB RAM の VPS/EC2: **$10〜$25/月**（1,500〜4,000円）
- DB/監視/メッセージキューを分けると: **$30〜$60/月**（5,000〜9,000円）

**結論**: 個人 bot の初期は最小構成で十分戦える

### 取引コスト（手数料・スプレッド）

**重要**: サーバー代より**取引コストの方が100倍以上大きい**ケースが普通

**GMOコインの手数料（現物取引・取引所利用時）**

主要銘柄（BTC・ETH・XRP・DAI 等）:
- Maker（指値）手数料: **-0.01%**（マイナス手数料＝リベート）
- Taker（成行）手数料: **0.05%**

その他銘柄:
- Maker 手数料: **-0.03%**
- Taker 手数料: **0.09%**

<details><summary>取引所の中で何が起きているか</summary>

**取引所には常にこんな板が動いています**：

- 買い注文（Bid）
- 売り注文（Ask）

これを並べているのが「板（Orderbook）」。

| 売り（Ask）   | 買い（Bid）   |
| --------- | --------- |
| 5,000,100 |           |
| 5,000,000 |           |
|           | 4,999,900 |
|           | 4,999,800 |

この状態であなたが 5,000,000円で買いたい（=成行 or 指値5,000,000） と注文すると、

板の一番上の売り注文（Ask 5,000,000）と「条件一致」→ マッチング → 取引成立 → あなたは BTC を手に入れる

これが “マッチング → 約定” の流れ。

</details>


**注意**: 販売所を使うとスプレッドが大きくコストが跳ねる（実質5%前後になるケースあり）

**手数料コストの計算**

月間売買代金 (V) に対して、手数料コストは:

```
手数料コスト = V × f
```

**例**: 月 50万円売買、Taker 手数料 0.05% の場合
```
500,000 × 0.0005 = 250円
```

### 混合手数料率の計算

複数銘柄を扱う場合の実効手数料率:

```
f_mix = (V_A × f_A + V_B × f_B + ...) / (V_A + V_B + ...)
```

**例**:
- 銘柄A（手数料0.05%）を 30万円
- 銘柄B（手数料0.09%）を 20万円

```
f_mix = (300,000 × 0.0005 + 200,000 × 0.0009) / 500,000
      = (150 + 180) / 500,000
      = 0.00066 (0.066%)
```

### 完全版損益モデル（1ヶ月）

**変数定義**

- (C): 運用資金（円）
- (p): 1回の取引に使う資金割合（例: 0.25 = 25%）
- (n): 1日のラウンドトリップ回数（買って→売って を1回）
- (d): 稼働日数（月30日）
- (e): 1ラウンドトリップあたりの期待エッジ（手数料・スリッページ前）
- (f_t): Taker手数料率（0.0005）
- (f_m): Maker手数料率（-0.0001）
- (q): Maker比率（0〜1、例: 0.6）
- (s): スリッページ率（往復で、例: 0.0003 = 0.03%）
- (S): サーバー等の固定費（円/月）

**計算式**

① 1回あたりの取引代金（往復の片道基準）
```
V_trade = C × p
```

② 月間売買代金（往復の片道基準）
```
V = V_trade × n × d
```

③ 実効手数料率（Maker/Taker混合）
```
f_eff = q × f_m + (1 - q) × f_t
```

④ 月間手数料
```
F = V × f_eff
```

⑤ 月間スリッページ
```
L = V × s
```

⑥ 月間の総利益（手数料・スリッページ前）
```
G = V × e
```

⑦ 月間純利益
```
P = G - F - L - S
```

**実例計算**

**デフォルト値**:
- 資金 (C = 200,000円)
- 取引割合 (p = 0.25)
- 1日回数 (n = 4)
- 稼働日 (d = 30)
- 期待エッジ (e = 0.001 = 0.10%)
- Maker比率 (q = 0.6)
- スリッページ (s = 0.0003 = 0.03%)
- 固定費 (S = 1,000円)

**計算結果**:
- 月間売買代金 (V = 6,000,000円)
- 総利益 (G = 6,000円)
- 実効手数料率 (f_eff = 0.00014 = 0.014%)
- 手数料 (F = 840円)
- スリッページ (L = 1,800円)
- **純利益 (P = 2,360円/月)**

**重要なポイント**: **手数料よりスリッページの方が普通に大きい**

### 損益分岐点の計算

純利益 (P ≥ 0) の条件:

```
e ≥ f_eff + s + S/V
```

**つまり**: 期待エッジ e が、実効手数料＋スリッページ＋固定費/取引量 を上回れば勝ち

**例**: 月間売買代金 V = 300万円 のとき
- f_eff = 0.00014
- s = 0.0003
- S/V = 1,000 / 3,000,000 ≈ 0.00033

合計コスト率: 0.00014 + 0.0003 + 0.00033 = 0.00077 (0.077%)

**結論**: **往復で 0.08% 以上の優位性が出せる戦略なら黒字**

### 資金×回転数の勝ち負けレンジ

同じ前提（p=0.25, e=0.10%, q=0.6, s=0.03%, S=1,000円）で、資金と回転数だけ変えた場合:

| 資金C | 回数n/日 | 月間売買代金V | 純利益P/月 |
|------|---------|-------------|-----------|
| 5万円 | 2 | 75万円 | -580円 |
| 5万円 | 4 | 150万円 | -160円 |
| 5万円 | 8 | 300万円 | +680円 |
| 10万円 | 2 | 150万円 | -160円 |
| 10万円 | 4 | 300万円 | +680円 |
| 10万円 | 8 | 600万円 | +2,360円 |
| 20万円 | 2 | 300万円 | +680円 |
| 20万円 | 4 | 600万円 | +2,360円 |
| 20万円 | 8 | 1,200万円 | +5,720円 |
| 50万円 | 2 | 750万円 | +3,200円 |
| 50万円 | 4 | 1,500万円 | +7,400円 |
| 50万円 | 8 | 3,000万円 | +15,800円 |

**読み方**:
- **資金が小さいなら回転数が必要**
- **回転数が少ない戦略は、資金があるほど有利**
- サーバー費は損益分岐には効くが、影響は小さい

### コスト最適化の優先順位

1. **スリッページ最適化**（最重要）
   - 板が厚い銘柄・時間帯を選ぶ
   - 指値寄りの執行
   - 約定アルゴリズム（追い指値など）

2. **Maker比率の最大化**
   - q が 0.6 -> 0.8 に上がるだけでコストが体感で半分に近づく

3. **過剰売買の抑制**
   - エッジが薄い局面で回転しない設計

4. **サーバー費**
   - 影響が最も小さい

### 本当に怖いコスト

サーバー費より、以下が利益を食う:

1. **スリッページ / 板の薄さ**
   - 特にアルトや国内取引所のマイナーペアは、数bp〜数十bp簡単に飛ぶ

2. **過剰取引（手数料地獄）**
   - シグナルが細かすぎると、勝ってても手数料で負ける

3. **レイテンシ＆再接続事故**
   - 取り逃しや二重発注は「一発で月利益が吹っ飛ぶ」系のコスト

4. **戦略の市場適合期間の短さ**
   - "バックテストで強い"と"1ヶ月後も強い"は別物

---

## 実装上のドメインルール

### 1. 異常系処理の実装

**必須対応項目**:

- **ネットワーク切断**: 自動再接続ロジック
- **API 制限**: レート制限の監視と待機
- **注文失敗**: リトライロジック（指数バックオフ推奨）
- **エラー返信**: エラーハンドリングとログ記録
- **ずれたタイムスタンプ**: タイムスタンプの検証と補正

### 2. 手数料の扱い

**実装方針**:

- 戦略レイヤーに「銘柄コストプロファイル」を与える

**例（JSON設定）**:
```json
{
  "BTC_JPY": { "taker_fee": 0.0005, "maker_fee": -0.0001 },
  "ETH_JPY": { "taker_fee": 0.0005, "maker_fee": -0.0001 },
  "DOGE_JPY": { "taker_fee": 0.0009, "maker_fee": -0.0003 }
}
```

- 約定履歴から実際の手数料を記録し、銘柄ごとの「実効手数料（f_eff）」を更新
- 銘柄ごとに「損益期待値 - 手数料 - スリッページ」を算出し、純利益の高い順に取引

### 3. スリッページ対策

**実装方針**:

- 板の厚さを監視し、薄い場合は取引を控える
- 指値注文を優先（Maker比率の最大化）
- 約定アルゴリズムの実装（追い指値など）

### 4. 取引回数の最適化

**実装方針**:

- エッジが薄い局面では取引しない
- 最小エッジ閾値を設定
- 無駄打ちを厳禁

### 5. コスト最適アーキテクチャ

**推奨構成**:

- VPS 1台（Lightsail/EC2 t4g.micro）で常時稼働
- 価格取得 WS と発注 REST をプロセス分離（コンテナでもOK）
- 状態管理は Redis（なければ sqlite でも出発可）
- ログはファイル＋ローテ、週一で S3/ローカル保管
- 重いバックテスト/学習は手元PCやスポットインスタンスで「必要時だけ」

これで月1,000円以内に収めつつ、事故率もかなり下げられる。

### 6. データ記録の要件

**記録すべき情報**:

- すべての取引履歴（日時、種別、数量、価格、手数料）
- 約定時の手数料率（API から取得可能な場合は記録）
- スリッページの実測値
- エラー・例外の詳細
- システム状態の変化

**保存期間**: 最低5年間（税務上の要件を考慮）

---

## まとめ

### 費用対効果の要点

- **サーバー代**: 月数百〜数千円で、影響は小さい
- **費用対効果の本丸**: 手数料・スリッページ・過剰取引・事故
- **損益分岐**: 控えめに見積もっても、月50万円くらい売買する戦略ならサーバー代は余裕で回収
- **結論**: 「サーバー費が気になるから bot は割に合わない」は誤解。割に合うかどうかは**戦略の期待値と運用の堅牢性**で決まる

### システム設計の要点

- **分離**: 価格取得・注文送信・戦略判断を分離
- **堅牢性**: 異常系処理を徹底
- **可視化**: ログ・トレーシングで「見えること」を実現
- **拡張性**: 戦略をプラグイン方式で差し替え可能に

### 実装時の優先順位

1. 異常系処理の実装
2. スリッページ最適化
3. Maker比率の最大化
4. 過剰売買の抑制
5. コスト計算の組み込み

---

## 参考資料

- [Amazon Lightsail Pricing](https://aws.amazon.com/lightsail/pricing/)
- [Binance Spot Trading Fee Rate](https://www.binance.com/en/fee/schedule)
- [GMOコイン API Documentation](https://api.coin.z.com/docs/en/)
- [GMOコイン 手数料ガイド](https://coin.z.com/jp/corp/guide/fees/)

